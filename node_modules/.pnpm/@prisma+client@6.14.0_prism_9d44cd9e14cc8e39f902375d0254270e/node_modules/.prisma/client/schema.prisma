// prisma/schema.prisma
// TG-Shop â€” Multi-tenant Telegram e-commerce schema (Final: Phase 1+2 + admin + shipments)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// ===== Enums =====

enum Currency {
  ETB
  USD
  EUR
}

enum OrderStatus {
  pending
  paid
  shipped
  completed
  cancelled
}

enum PaymentProvider {
  STRIPE
  TELEBIRR
  WEBIRR
  MANUAL
}

enum PaymentStatus {
  requires_payment
  processing
  succeeded
  failed
  canceled
  refunded
}

enum InventoryMoveType {
  IN
  OUT
  ADJUST
}

enum WebhookType {
  PAYMENT
  FULFILLMENT
  OTHER
}

enum PlanInterval {
  MONTH
  YEAR
}

enum SubscriptionStatus {
  active
  past_due
  canceled
  trialing
  inactive
}

enum ShopRole {
  OWNER
  HELPER
  COLLABORATOR
  MEMBER
}

enum ReviewStatus {
  pending
  approved
  rejected
}

enum ContactType {
  message
  call
}

enum ReportTarget {
  TENANT
  PRODUCT
}

enum PlatformRole {
  USER
  ADMIN
  MOD
}

enum ShipmentStatus {
  pending
  packed
  shipped
  delivered
  canceled
  returned
}

enum ShopStatus {
  open
  closed
  paused
}

enum DeliveryMode {
  delivery
  pickup
  both
}

/// ===== Core Multi-tenant Entities =====

model Tenant {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Public profile / universal marketplace controls
  publicPhone      String?
  publishUniversal Boolean @default(false)

  // NEW: shop public/profile fields
  description        String? // short text for header / shop card
  aboutText          String? // longer text for "About" tab
  location           String? // e.g. "Addis Ababa"
  deliveryRules      String? // e.g. "Delivery 200 ETB", "Pickup only"
  status             ShopStatus   @default(open)
  deliveryMode       DeliveryMode @default(both)
  logoImageId        String?
  bannerUrl          String?
  defaultCurrency    Currency?
  minOrderAmount     Decimal?     @db.Decimal(10, 2)
  businessHours      Json? // flexible open/close per day
  publicTelegramLink String? // public channel/group/bot for buyers

  // Per-tenant Telegram config
  botToken    String?
  botUsername String?
  postChatId  String?

  // Hardening for future encrypted bot tokens
  botTokenEnc    Bytes?
  botTokenNonce  Bytes?
  botTokenKmsKey String?

  // Back-relations
  addresses       Address[]
  productImages   ProductImage[]
  productVariants ProductVariant[]
  inventoryMoves  InventoryMove[]
  cartItems       CartItem[]
  orderItems      OrderItem[]
  favorites       Favorite[]
  paymentIntents  PaymentIntent[]
  webhookEvents   WebhookEvent[]
  subscriptions   TenantSubscription[]
  invoices        TenantInvoice[]
  tenantPayments  TenantPayment[]
  products        Product[]
  carts           Cart[]
  orders          Order[]
  shipments       Shipment[]
  contactIntents  ContactIntent[]
  blockList       BlockList[]
  memberships     Membership[]
  invites         ShopInvite[]
  sessions        MiniAppSession[]
  settings        TenantSettings?
  productViews    ProductView[]
  reports         Report[]
  membershipAudit MembershipAudit[]

  // if you add pinned model â†“
  pinnedProducts PinnedProduct[]

  @@index([slug])
}

model PinnedProduct {
  id        String   @id @default(cuid())
  tenantId  String
  productId String
  position  Int      @default(0)
  createdAt DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([tenantId, productId])
  @@index([tenantId, position])
}

model User {
  tgId     String  @id
  username String?
  name     String?
  phone    String?

  country          String?
  city             String?
  place            String?
  specialReference String?

  avatarUrl String?

  platformRole PlatformRole @default(USER)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  orders      Order[]
  carts       Cart[]
  favorites   Favorite[]
  addresses   Address[]
  memberships Membership[]
  sessions    MiniAppSession[]
}

/// Shipping / billing address scoped to a tenant+user
model Address {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  label      String?
  line1      String
  line2      String?
  city       String
  region     String?
  country    String
  postalCode String?
  latitude   Float?
  longitude  Float?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User    @relation(fields: [userId], references: [tgId])
  Order  Order[]

  @@unique([tenantId, userId, label])
  @@index([tenantId])
  @@index([userId])
}

/// ===== Catalog =====
model Category {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String  @map("title")
  description String?

  icon     String? // âœ… optional emoji or small icon name (e.g. "ðŸš—" or "mdi-car")
  imageId  String? // âœ… optional R2 image (for thumbnails)
  // hierarchy
  parentId String?
  parent   Category?  @relation("CategoryChildren", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryChildren")

  level    Int     @default(0)
  position Int     @default(0)
  isActive Boolean @default(true) @map("active")

  products Product[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  CategoryName    CategoryName[]
  CategorySynonym CategorySynonym[]

  @@index([parentId, position])
  @@index([isActive])
  @@index([level])
}

model CategoryName {
  id         String   @id @default(cuid())
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  locale     String // e.g., "en", "de", "am"
  name       String

  @@unique([categoryId, locale])
  @@index([locale])
}

model CategorySynonym {
  id         String   @id @default(cuid())
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  locale     String? // null = global synonym
  value      String

  @@index([categoryId])
  @@index([value])
}

model Product {
  id          String   @id @default(cuid())
  tenantId    String
  title       String
  description String?
  sku         String?
  price       Decimal  @db.Decimal(10, 2)
  currency    Currency

  stock     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Category
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Publication flags
  isPublished        Boolean      @default(false) // visible in personal shop
  publishToUniversal Boolean      @default(false) // candidate for universal feed
  reviewStatus       ReviewStatus @default(pending) // moderation state
  reviewedAt         DateTime?
  reviewedBy         String?

  // Relations
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  images         ProductImage[]
  variants       ProductVariant[]
  favorites      Favorite[]
  inventory      InventoryMove[]
  orderItems     OrderItem[]
  CartItem       CartItem[]
  contactIntents ContactIntent[]
  views          ProductView[]
  reports        Report[]

  pinnedInShops PinnedProduct[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([active])
  @@index([title])
  @@index([tenantId, categoryId])
  @@index([publishToUniversal, reviewStatus, active, createdAt], name: "universal_feed_idx")
}

model ProductImage {
  id        String  @id @default(cuid())
  tenantId  String
  productId String
  imageId   String?
  url       String?
  tgFileId  String?
  alt       String?
  position  Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  image   Image?  @relation(fields: [imageId], references: [id])

  @@index([tenantId])
  @@index([productId])
}

model Image {
  id            String   @id @default(cuid())
  sha256        String   @unique
  bucketKeyBase String
  width         Int
  height        Int
  mime          String
  tenantId      String?
  createdAt     DateTime @default(now())

  productImages ProductImage[]

  @@index([tenantId])
}

model ProductVariant {
  id        String   @id @default(cuid())
  tenantId  String
  productId String
  name      String
  priceDiff Decimal? @db.Decimal(10, 2)
  sku       String?
  stock     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([productId])
}

/// Stock mutations per product
model InventoryMove {
  id        String            @id @default(cuid())
  tenantId  String
  productId String
  kind      InventoryMoveType
  quantity  Int
  reason    String?
  createdAt DateTime          @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([productId])
}

/// ===== Carts & Orders =====

model Cart {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User       @relation(fields: [userId], references: [tgId])
  items  CartItem[]

  @@unique([tenantId, userId]) // one cart per user *per tenant*
  @@index([tenantId])
  @@index([userId])
}

model CartItem {
  id        String   @id @default(cuid())
  tenantId  String
  cartId    String
  productId String
  variantId String?
  quantity  Int      @default(1)
  unitPrice Decimal  @db.Decimal(10, 2)
  currency  Currency
  createdAt DateTime @default(now())

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cart    Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  // NOTE: In Postgres, UNIQUE with nullable variantId allows multiple NULLs.
  // If you must dedupe NULL variants, enforce in application logic.
  @@unique([tenantId, cartId, productId, variantId])
  @@index([tenantId])
  @@index([cartId])
  @@index([productId])
  @@index([variantId])
}

model Order {
  id        String      @id @default(cuid())
  tenantId  String
  userId    String
  status    OrderStatus @default(pending)
  total     Decimal     @db.Decimal(10, 2)
  currency  Currency
  addressId String?
  note      String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  shortCode String?     @unique

  // Address snapshot (immutable for audit/history)
  shipName    String?
  shipPhone   String?
  shipLine1   String?
  shipLine2   String?
  shipCity    String?
  shipRegion  String?
  shipCountry String?
  shipPostal  String?

  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [tgId])
  address   Address?        @relation(fields: [addressId], references: [id])
  items     OrderItem[]
  payments  PaymentIntent[]
  shipments Shipment[]

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([tenantId, status, createdAt])
}

model OrderItem {
  id              String   @id @default(cuid())
  tenantId        String
  orderId         String
  productId       String
  variantId       String?
  quantity        Int      @default(1)
  unitPrice       Decimal  @db.Decimal(10, 2)
  currency        Currency
  titleSnapshot   String?
  variantSnapshot String?

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([tenantId])
  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

/// Shipment / fulfillment lifecycle (separate from payment)
model Shipment {
  id          String         @id @default(cuid())
  tenantId    String
  orderId     String
  status      ShipmentStatus @default(pending)
  carrier     String?
  trackingNo  String?
  shippedAt   DateTime?
  deliveredAt DateTime?
  meta        Json?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([orderId, status])
}

/// Wishlist / likes
model Favorite {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  productId String
  createdAt DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [tgId])
  product Product @relation(fields: [productId], references: [id])

  @@unique([tenantId, userId, productId])
  @@index([tenantId])
  @@index([userId])
  @@index([productId])
}

/// ===== Universal Shop: Contacts, Memberships, Invites, Sessions, Views, Reports =====

model ContactIntent {
  id        String      @id @default(cuid())
  tenantId  String
  productId String
  buyerTgId String
  type      ContactType
  createdAt DateTime    @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([productId])
  @@index([buyerTgId])
}

model BlockList {
  id        String   @id @default(cuid())
  tenantId  String
  buyerTgId String
  reason    String?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, buyerTgId])
  @@index([tenantId])
}

model Membership {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  role      ShopRole @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [tgId])

  @@unique([tenantId, userId])
  @@index([tenantId, role])
  @@index([userId])
}

model ShopInvite {
  id        String    @id @default(cuid())
  tenantId  String
  code      String    @unique
  role      ShopRole  @default(MEMBER)
  createdBy String
  maxUses   Int?
  usedCount Int       @default(0)
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([expiresAt])
}

model MiniAppSession {
  id       String   @id @default(cuid())
  userId   String
  tgChatId String?
  initHash String
  openedAt DateTime @default(now())
  tenantId String?

  user   User    @relation(fields: [userId], references: [tgId])
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([userId, openedAt])
  @@index([tenantId])
}

model TenantSettings {
  tenantId             String  @id
  checkoutEnabled      Boolean @default(true)
  universalEnabled     Boolean @default(true)
  allowDMFromUniversal Boolean @default(true)
  locale               String?
  timezone             String?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model ProductView {
  id         String   @id @default(cuid())
  tenantId   String
  productId  String
  viewerTgId String?
  source     String? // "local" | "universal" | "bot"
  createdAt  DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([productId, createdAt])
}

model Report {
  id           String       @id @default(cuid())
  target       ReportTarget
  tenantId     String
  productId    String?
  reporterTgId String?
  reason       String?
  createdAt    DateTime     @default(now())
  resolvedAt   DateTime?
  resolvedBy   String?

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([productId])
}

/// Audit trail for membership changes (optional but recommended)
model MembershipAudit {
  id        String    @id @default(cuid())
  tenantId  String
  actorId   String // who performed the change (OWNER/ADMIN)
  targetId  String // whose membership changed
  action    String // "INVITE_CREATE" | "JOIN_ACCEPT" | "ROLE_UPDATE" | "REMOVE" | "TRANSFER_OWNERSHIP"
  fromRole  ShopRole?
  toRole    ShopRole?
  createdAt DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([actorId])
  @@index([targetId])
}

/// ===== Payments & Webhooks (per order) =====

model PaymentIntent {
  id          String          @id @default(cuid())
  tenantId    String
  orderId     String
  provider    PaymentProvider
  providerRef String?
  amount      Decimal         @db.Decimal(10, 2)
  currency    Currency
  status      PaymentStatus   @default(requires_payment)
  meta        Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([orderId])
  @@index([provider, providerRef])
}

model WebhookEvent {
  id         String           @id @default(cuid())
  tenantId   String
  provider   PaymentProvider?
  type       WebhookType
  payload    Json
  receivedAt DateTime         @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([receivedAt])
}

/// ===== Plans & Billing for Tenants =====

model Plan {
  id        String       @id @default(cuid())
  name      String
  price     Decimal      @db.Decimal(10, 2)
  currency  Currency
  interval  PlanInterval
  active    Boolean      @default(true)
  features  Json?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  subscriptions TenantSubscription[]
}

model TenantSubscription {
  id          String             @id @default(cuid())
  tenantId    String
  planId      String
  status      SubscriptionStatus @default(active)
  startAt     DateTime
  endAt       DateTime?
  trialEndsAt DateTime?
  meta        Json?

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan     Plan            @relation(fields: [planId], references: [id])
  invoices TenantInvoice[]

  @@index([tenantId])
  @@index([planId])
  @@index([status])
}

model TenantInvoice {
  id             String    @id @default(cuid())
  tenantId       String
  subscriptionId String
  number         String    @unique
  amountDue      Decimal   @db.Decimal(10, 2)
  currency       Currency
  issuedAt       DateTime  @default(now())
  dueAt          DateTime?
  paidAt         DateTime?
  meta           Json?

  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription TenantSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  payments     TenantPayment[]

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([issuedAt])
}

model TenantPayment {
  id          String          @id @default(cuid())
  tenantId    String
  invoiceId   String?
  provider    PaymentProvider
  providerRef String?
  amount      Decimal         @db.Decimal(10, 2)
  currency    Currency
  status      PaymentStatus   @default(processing)
  createdAt   DateTime        @default(now())
  meta        Json?

  tenant  Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice TenantInvoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([invoiceId])
  @@index([provider, providerRef])
}
